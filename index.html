<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Конструктор Project Food</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --main: #2563eb; --bg: #f8fafc; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; display: flex; height: 100vh; }
        
        /* Боковая панель со списком 139 блюд */
        .sidebar { width: 300px; background: white; border-right: 1px solid #e2e8f0; overflow-y: auto; padding: 10px; }
        .recipe-item { padding: 10px; cursor: pointer; border-radius: 8px; margin-bottom: 5px; transition: 0.2s; }
        .recipe-item:hover { background: #eff6ff; }
        .recipe-item.active { background: var(--main); color: white; }

        /* Основная область редактора */
        .editor { flex: 1; padding: 30px; overflow-y: auto; }
        .form-group { margin-bottom: 20px; }
        label { display: block; font-weight: 600; margin-bottom: 8px; color: #1e293b; }
        input, textarea, select { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; box-sizing: border-box; }
        textarea { height: 200px; line-height: 1.5; }
        
        .btn { background: var(--main); color: white; padding: 12px 25px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .preview-img { width: 100%; max-width: 400px; height: 250px; object-fit: cover; border-radius: 12px; display: none; margin-top: 10px; }
    </style>
</head>
<body>

<div class="sidebar" id="recipeList">
    <h3>Мои Рецепты (139)</h3>
    <div id="itemsContainer">Загрузка списка...</div>
</div>

<div class="editor" id="editorArea" style="display:none;">
    <h2 id="editTitle">Редактирование</h2>
    
    <div class="form-group">
        <label>Фото блюда</label>
        <input type="file" id="fileInput" accept="image/*">
        <img id="imgPreview" class="preview-img">
    </div>

    <div class="form-group">
        <label>Полный рецепт (пошагово)</label>
        <textarea id="instructionsInput" placeholder="Шаг 1. Сварить бульон..."></textarea>
    </div>

    <div class="form-group">
        <label>Полезные советы</label>
        <input type="text" id="tipsInput" placeholder="Например: подавать со сметаной">
    </div>

    <button class="btn" onclick="saveRecipe()">Сохранить изменения</button>
</div>

<script>
    const SUPABASE_URL = 'https://your-project.supabase.co';
    const SUPABASE_KEY = 'your-anon-key';
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let currentRecipeId = null;

    // 1. Загрузка списка блюд
    async function fetchRecipes() {
        const { data } = await supabase.from('recipes').select('id, name').order('name');
        const container = document.getElementById('itemsContainer');
        container.innerHTML = data.map(r => `
            <div class="recipe-item" onclick="openEditor(${r.id}, '${r.name}')">${r.name}</div>
        `).join('');
    }

    // 2. Открытие редактора
    async function openEditor(id, name) {
        currentRecipeId = id;
        document.getElementById('editorArea').style.display = 'block';
        document.getElementById('editTitle').innerText = name;
        
        const { data } = await supabase.from('recipes').select('*').eq('id', id).single();
        
        document.getElementById('instructionsInput').value = data.instructions || '';
        document.getElementById('tipsInput').value = data.tips || '';
        
        const img = document.getElementById('imgPreview');
        if (data.image_url) {
            img.src = data.image_url;
            img.style.display = 'block';
        } else {
            img.style.display = 'none';
        }
    }

    // 3. Сохранение (включая загрузку фото)
    async function saveRecipe() {
        const file = document.getElementById('fileInput').files[0];
        let publicUrl = document.getElementById('imgPreview').src;

        // Если выбран новый файл — грузим в Storage
        if (file) {
            const fileName = `recipe_${currentRecipeId}_${Date.now()}`;
            const { data: uploadData } = await supabase.storage
                .from('recipe-images')
                .upload(fileName, file);
            
            if (uploadData) {
                const { data: urlData } = supabase.storage
                    .from('recipe-images')
                    .getPublicUrl(fileName);
                publicUrl = urlData.publicUrl;
            }
        }

        // Обновляем данные в таблице
        const { error } = await supabase.from('recipes').update({
            instructions: document.getElementById('instructionsInput').value,
            tips: document.getElementById('tipsInput').value,
            image_url: publicUrl
        }).eq('id', currentRecipeId);

        if (!error) {
            alert('Рецепт сохранен успешно!');
            location.reload();
        }
    }

    fetchRecipes();
</script>

</body>
</html>
